---
title: "Using the `stlcsb` Package"
author: "Branson Fox and Christopher Prener"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{stlcsb}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Overview

The `stlcsb` package is meant to provide easy access to the [City of St. Louis](https://www.stlouis-mo.gov) [Citizen's Service Bureau](https://www.stlouis-mo.gov/government/departments/public-safety/neighborhood-stabilization-office/citizens-service-bureau/) [data](https://www.stlouis-mo.gov/data/service-requests.cfm) in `R`

### Tips

* All functions support non-standard evaluation, meaning you can use either quoted or unquoted inputs for arguments.
* Use RStudio for its helpful auto completion ability. Type "csb_" to see all of the functions available in this package, or "cat_" to see all of the category data objects.
* All functions return data as a tibble, which is essentially identical to a data.frame, except for its print behavior in the console and in notebooks.

## Downloading CSB Data

Before using the other functions, you will need to acquire the CSB data. The `csb_get_data` function will download the most recent version of the data, and return it as a single tibble. By default, variable names are clean-up automatically and two variables that largely containin `NA` values are removed (`PROBCITY` and `PROBZIP`). Variables are also reordered in a more logical fashion.

```r
> csb <- csb_get_data()
trying URL 'https://www.stlouis-mo.gov/data/upload/data-files/csb.zip'
Content type 'application/x-zip-compressed' length 60999726 bytes (58.2 MB)
==================================================
downloaded 58.2 MB

>
> names(csb)
 [1] "requestid"       "datetimeinit"    "probaddress"     "probaddtype"    
 [5] "callertype"      "neighborhood"    "ward"            "problemcode"    
 [9] "description"     "submitto"        "status"          "dateinvtdone"   
[13] "datetimeclosed"  "prjcompletedate" "datecancelled"   "srx"            
[17] "sry"            
```

The `tidy = FALSE` argument for `csb_get_data()` will return a tibble with both variables as well as the original variable names in the order they are disseminated by the City:

```r
> csb <- csb_get_data(tidy = FALSE)
trying URL 'https://www.stlouis-mo.gov/data/upload/data-files/csb.zip'
Content type 'application/x-zip-compressed' length 60999726 bytes (58.2 MB)
==================================================
downloaded 58.2 MB

>
> names(csb)
 [1] "CALLERTYPE"      "DATECANCELLED"   "DATEINVTDONE"    "DATETIMECLOSED" 
 [5] "DATETIMEINIT"    "DESCRIPTION"     "NEIGHBORHOOD"    "PRJCOMPLETEDATE"
 [9] "PROBADDRESS"     "PROBADDTYPE"     "PROBCITY"        "PROBLEMCODE"    
[13] "PROBZIP"         "REQUESTID"       "SRX"             "SRY"            
[17] "STATUS"          "SUBMITTO"        "WARD"  
```

It is also possible to only import a single year or a range of years:

```r
csb18 <- csb_get_data(years = 2018)
csb16_18 <- csb_get_data(years = 2016:2018)
```

### Variable Definitions
The `csb_load_variables()` function is available to provide descriptions of each variable. Like `csb_get_data()`, this function returns the tidy version by default, but can be set to return the regular version as well (with `tidy = FALSE`):

```r
> csb_load_variables()
trying URL 'https://www.stlouis-mo.gov/data/upload/data-files/CSB-Request-Dataset-Field-Definitions.xlsx'
Content type 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' length 4976 bytes
==================================================
downloaded 4976 bytes

# A tibble: 17 x 2                                                                       
   Name           Description                                                           
   <chr>          <chr>                                                                 
 1 requestid      System generated unique record number                                 
 2 datetimeinit   Date/Time the request was initiated...
 3 probaddress    The address where the problem is occurring  

<OUTPUT TRUNCATED>
```

### Date of Last Update
These data are updated on a weekly basis, so it may be useful to know what version you are working with. `The csb_last_update()` function will return the date that the data were last modified as a string:

```r
> csb_last_update()
[1] "2/2/19"
```

## Categorization

The most important problem identified initially was the lack of intelligible categorization of Problem codes. These categories were created by personal observation. There are several functions available to represent data categorically.

`csb_categorize()` can be used to categorize data based on its Problem code.
```{r categorize, eval=FALSE}
csb_categorize(csb, problemcode, Category)
```

`csb_filter()` can be used to filter the data based on these same categories. These categories will automatically populate by typing "cat_" if using RStudio. Category takes single or vector arguments.

```{r filter, eval=FALSE}
csb_filter(csb, problemcode, category = c(cat_construction, cat_debris))
```

`csb_vacant()` is used for appending a logical vector indicating vacancy related problemcodes. It is important to know that vacant exists inclusive of other categories, or in other words, a problem code may be vacancy related in addition to its core category.
```{r vacant, eval=FALSE}
csb_vacant(csb, problemcode, vacant)
```

`csb_cancelled` is used for the removal of csb requests that were cancelled. By default it deletes the column specified.
```{r cancelled, eval=FALSE}
csb_cancelled(csb, datecancelled)
csb_cancelled(csb, datecancelled, drop = FALSE)
```

## Spatial Features

The `stlcsb` package also provides helpful functions for dealing with spatial data.

`csb_missingXY` is used to identify observations with incomplete or invalid spatial data.
```{r missing, eval=FALSE}
csb_missing <- csb_missingXY(csb, srx, sry, missing)
```

`csb_projectXY` is used to create a simple features object, which can then be manipulated spatially. It is mandatory that missing spatial data be removed first. The coordinate reference system can be re-projected by specifying a numeric epsg code or a proj4 character string 
```{r geo, eval=FALSE}
csb_no_missing <- dplyr::filter(csb_missing, missing == FALSE)
csb_sf <- csb_projectXY(csb_no_missing, srx, sry)
```

If you prefer to work with these data in a traditional GIS program (QGIS, ArcGIS, etc.) the best way to export the data is using the `st_write()` function of the `sf` package.
```{r shape, eval=FALSE}
sf::st_write(csb_sf, "users/data/csb_calls.shp")
```

## Time and Date
The package offers two functions for handling time and date.

`csb_date_filter` is used to filter observation for a specified time period. It is flexible in syntax, accepting 3 letter abbreviations, full month names, or a numeric argument.
```{r date filter, eval=FALSE}
csb_date_filter(csb, datetimeinit, day = 1)
csb_date_filter(csb, datetimeinit, day = 1:15, month = 1)
csb_date_filter(csb, datetimeinit, month = "January", year = 09)
csb_date_filter(csb, datetimeinit, month = c("jan", "feb", "Mar", "Apr"), year = 2009)
csb_date_filter(csb, datetimeinit, day = 1:15, month = 1:6, year = 08:13)
```

`csb_date_parse` is used to parse part of, or whole dates from observations. It too can delete the original date variable. Arguments are the names of the variables to be appended to the data.
```{r date parse, eval=FALSE}
csb_date_parse(csb, datetimeinit, day = dayInit)
csb_date_parse(csb, datetimeinit, day = dayInit, month = monthInit)
csb_date_parse(csb, datetimeinit, month = monthInit)
csb_date_parse(csb, datetimeinit, month = monthInit, year = yearInit)
csb_date_parse(csb, datetimeinit, dayInit, monthInit, yearInit, drop = TRUE)
```

## Full Example: Mapping Potential Vacant Properties in Summer 2017

The following is an example of a full workflow for importing the data, filtering for vacancy indicating problem codes, filtering by time, removing observations with missing spatial data, projecting it to an sf object, and finally plotting it. Notice that the pipe operator `%>%` from magrittr is used. This passes the output of the prior function to the first argument of the next function, reducing typing and making code easier to read.
```{r full example, eval=FALSE}
csb <- csb_get_data()

csb_vacant(csb, problemcode, vacant) %>%
  dplyr::filter(vacant == TRUE) %>%
  csb_date_filter(datetimeinit, month = c("Jun", "Jul", "Aug"), year = 2017) %>%
  csb_missingXY(srx, sry, missing) %>%
  dplyr::filter(missing == FALSE) %>%
  csb_projectXY(srx, sry) -> vacant_sf

plot(vacant_sf)
```
## Questions, Recommendations, Requests

This package is maintained by Christopher Prener, PhD. Please direct any correspondence to his email. (chris.prener@slu.edu) 

Or, open an issue at https://github.com/slu-openGIS/stlcsb/issues/
